{% extends 'base_back.html.twig' %}

{% block title %}{{ isEdit ? 'Modifier' : 'Nouvelle' }} Question - Admin{% endblock %}

{% block body %}
<div class="page-header">
    <div>
        <h1 class="page-title">{{ isEdit ? 'Modifier une question' : 'Nouvelle question' }}</h1>
        <p class="page-subtitle">{{ isEdit ? 'Modifier les détails de la question' : 'Créer une nouvelle question de quiz' }}</p>
    </div>
</div>

<div class="form-layout">
    <div class="form-main">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Détails de la question</h4>
                {% if mistral_configured %}
                    <button type="button" id="generate-mistral-btn" class="btn btn-primary" style="float: right;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 5px;">
                            <path d="M13 2L3 14h9l-1-8 9-5-4 6z"/>
                            <path d="M13 2L3 14h9l-1-8 9-5-4 6z"/>
                        </svg>
                        Générer avec Mistral
                    </button>
                {% else %}
                    <button type="button" class="btn btn-secondary" style="float: right;" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 5px;">
                            <path d="M13 2L3 14h9l-1-8 9-5-4 6z"/>
                            <path d="M13 2L3 14h9l-1-8 9-5-4 6z"/>
                        </svg>
                        API Mistral non configurée
                    </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if errors is defined and errors|length > 0 %}
                    <div class="alert alert-danger">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <ul style="margin: 0; padding-left: 20px;">
                            {% for error in errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                {# HTML5 validation disabled - using Symfony validators instead #}
                <form method="post" novalidate>
                    {# Énoncé de la question #}
                    <div class="form-group">
                        <label class="form-label" for="enonce">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <line x1="12" y1="16" x2="12" y2="12"/>
                                <line x1="12" y1="8" x2="12.01" y2="8"/>
                            </svg>
                            Énoncé de la question *
                        </label>
                        <textarea id="enonce" 
                                  name="enonce" 
                                  class="form-control" 
                                  rows="4" 
                                  {# required #}
                                  placeholder="Ex: Comment gérez-vous le stress quotidien?"
                        >{{ question.enonce ?? '' }}</textarea>
                        <small class="form-hint">Formulez une question claire et concise</small>
                    </div>

                    {# Réponse correcte #}
                    <div class="form-group">
                        <label class="form-label" for="reponse_correcte">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            Réponse correcte *
                        </label>
                        <input type="text" 
                               id="reponse_correcte" 
                               name="reponse_correcte" 
                               class="form-control" 
                               value="{{ question.reponseCorrecte ?? '' }}" 
                               {# required #}
                               placeholder="Ex: Je pratique la méditation">
                        <small class="form-hint">La bonne réponse à la question</small>
                    </div>

                    {# Options fausses #}
                    <div class="form-group">
                        <label class="form-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                            Options incorrectes *
                        </label>
                        {% set options = question.optionsFaussesArray ?? ['', '', ''] %}
                        <input type="text" 
                               name="option_1" 
                               class="form-control mb-2" 
                               value="{{ options[0] ?? '' }}" 
                               placeholder="Option incorrecte 1">
                        <input type="text" 
                               name="option_2" 
                               class="form-control mb-2" 
                               value="{{ options[1] ?? '' }}" 
                               placeholder="Option incorrecte 2">
                        <input type="text" 
                               name="option_3" 
                               class="form-control" 
                               value="{{ options[2] ?? '' }}" 
                               placeholder="Option incorrecte 3">
                        <small class="form-hint">Fournissez 2 à 3 options incorrectes</small>
                    </div>

                    {# Points #}
                    <div class="form-group">
                        <label class="form-label" for="points_valeur">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            Points *
                        </label>
                        {# HTML5 type=number disabled - using Symfony Range validator instead #}
                        <input type="text" 
                               id="points_valeur" 
                               name="points_valeur" 
                               class="form-control" 
                               value="{{ question.pointsValeur ?? 10 }}" 
                               {# min="1" #}
                               {# max="100" #}
                               {# required #}>
                        <small class="form-hint">Points attribués pour une bonne réponse</small>
                    </div>

                    {# Actions #}
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"/>
                            </svg>
                            {{ isEdit ? 'Enregistrer les modifications' : 'Créer la question' }}
                        </button>
                        <a href="{{ path('app_mental_admin_questions') }}" class="btn btn-secondary">
                            Annuler
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="form-sidebar">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Informations</h4>
            </div>
            <div class="card-body">
                <div class="info-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="16" x2="12" y2="12"/>
                        <line x1="12" y1="8" x2="12.01" y2="8"/>
                    </svg>
                    <div>
                        <strong>Structure du quiz</strong>
                        <p>Chaque question est composée d'un énoncé, d'une réponse correcte et de 2-3 options incorrectes.</p>
                    </div>
                </div>
                <div class="info-item">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <div>
                        <strong>Système de points</strong>
                        <p>Attribuez plus de points aux questions plus difficiles ou importantes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const enonceField = document.getElementById('enonce');
    const reponseCorrecteField = document.getElementById('reponse_correcte');
    const option1Field = document.querySelector('input[name="option_1"]');
    const option2Field = document.querySelector('input[name="option_2"]');
    const option3Field = document.querySelector('input[name="option_3"]');
    const pointsField = document.getElementById('points_valeur');
    const generateBtn = document.getElementById('generate-mistral-btn');

    // Gestionnaire du bouton "Générer avec Mistral"
    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            try {
                // Désactiver le bouton et afficher le chargement
                generateBtn.disabled = true;
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 5px; animation: spin 1s linear infinite;">
                        <path d="M21 12a9 9 0 11-6.219-8.56"/>
                    </svg>
                    Génération en cours...
                `;

                // Appel à l'API
                const response = await fetch('/bo/mental/questions/generate-mistral', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    // Remplir les champs avec les données générées
                    enonceField.value = data.data.enonce || '';
                    reponseCorrecteField.value = data.data.reponse_correcte || '';
                    option1Field.value = data.data.options_fausses[0] || '';
                    option2Field.value = data.data.options_fausses[1] || '';
                    option3Field.value = data.data.options_fausses[2] || '';
                    pointsField.value = data.data.points_valeur || 10;

                    showNotification('Question générée avec succès !', 'success');
                } else {
                    showNotification('Erreur: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Erreur:', error);
                showNotification('Erreur lors de la génération de la question', 'error');
            } finally {
                // Réactiver le bouton
                generateBtn.disabled = false;
                generateBtn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; margin-right: 5px;">
                        <path d="M13 2L3 14h9l-1-8 9-5-4 6z"/>
                        <path d="M13 2L3 14h9l-1-8 9-5-4 6z"/>
                    </svg>
                    Générer avec Mistral
                `;
            }
        });
    }

    // Fonction de validation de formulaire
    function validateForm() {
        const enonce = enonceField.value.trim();
        const reponseCorrecte = reponseCorrecteField.value.trim();
        const option1 = option1Field.value.trim();
        const option2 = option2Field.value.trim();
        const option3 = option3Field.value.trim();
        const points = pointsField.value.trim();

        if (!enonce || !reponseCorrecte || option1 === '' || option2 === '' || option3 === '' || !points || points <= 0) {
            return false;
        }

        return true;
    }

    // Écouteur de soumission du formulaire
    document.querySelector('form[method="post"]').addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            showNotification('Veuillez remplir tous les champs obligatoires avant de soumettre.', 'error');
            return;
        }

        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Enregistrement...';
        }
    });
});

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type}`;
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${type === 'success' ? 
                '<path d="M22 11.08V12a10 10 0 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' :
                '<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12.01"/><line x1="12" y1="8" x2="12" y2="8"/>'
            }
        </svg>
        ${message}
    `;

    document.body.appendChild(notification);

    // Supprimer après 3 secondes
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}
</script>

<style>
.alert {
    padding: 12px 16px;
    border-radius: 6px;
    margin-bottom: 20px;
    border-left: 4px solid #4CAF50;
}

.alert-success {
    background-color: #d4edda;
    border-left-color: #4CAF50;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border-left-color: #f5c6cb;
    color: #721c24;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
