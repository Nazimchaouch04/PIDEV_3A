{% extends 'base_back.html.twig' %}

{% block title %}Historique des ActivitÃ©s{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .filters-container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        margin-bottom: 25px;
    }
    .filters-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    .filter-group label {
        font-size: 13px;
        font-weight: 600;
        color: #4A5568;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .filter-group select,
    .filter-group input {
        padding: 10px 14px;
        border: 2px solid #E2E8F0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
        transition: all 0.2s;
    }
    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #6C5CE7;
    }
    .filter-buttons {
        display: flex;
        gap: 10px;
    }
    .btn-filter {
        padding: 10px 20px;
        background: #6C5CE7;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .btn-filter:hover {
        background: #5A4FCF;
    }
    .btn-reset {
        padding: 10px 20px;
        background: #EDF2F7;
        color: #4A5568;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s;
    }
    .btn-reset:hover {
        background: #E2E8F0;
    }
    /* Badges colorÃ©s cohÃ©rents */
    .badge-login {
        background: #C6F6D5 !important;
        color: #22543D !important;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-logout {
        background: #BEE3F8 !important;
        color: #2A4365 !important;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-failed {
        background: #FED7D7 !important;
        color: #742A2A !important;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-suspicious {
        background: #FEEBC8 !important;
        color: #7C2D12 !important;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-password {
        background: #E9D8FD !important;
        color: #44337A !important;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-default {
        background: #E2E8F0 !important;
        color: #2D3748 !important;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .badge-role {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
    }
    .badge-role-admin {
        background: #FED7D7;
        color: #742A2A;
    }
    .badge-role-user {
        background: #C6F6D5;
        color: #22543D;
    }
    .badge-role-coach {
        background: #FEEBC8;
        color: #7C2D12;
    }
    .badge-role-specialist {
        background: #E9D8FD;
        color: #44337A;
    }
</style>
{% endblock %}

{% block body %}
<div class="bo-mental-dashboard">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="page-title">Historique des Logs</h1>
            <p class="page-subtitle">Suivi complet de l'activitÃ© sur l'application BioSync</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <form method="POST" action="{{ path('app_admin_logs_clear') }}" style="display: inline;" onsubmit="return confirm('ÃŠtes-vous sÃ»r de vouloir effacer tous les logs ? Cette action est irrÃ©versible.');">
                <button type="submit" class="btn btn-danger" style="background-color: #E53E3E; border-color: #E53E3E; display: flex; align-items: center; gap: 8px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Effacer l'historique
                </button>
            </form>
            <a href="{{ path('app_admin_logs_statistics') }}" class="btn btn-success" style="background-color: #48BB78; border-color: #48BB78; display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                Statistiques
            </a>
            <a href="{{ path('app_admin_logs_pdf', {role: filters.role, action_type: filters.action_type, date_from: filters.date_from, date_to: filters.date_to}) }}" class="btn btn-primary" style="background-color: #6C5CE7; border-color: #6C5CE7; display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Exporter en PDF
            </a>
        </div>
    </div>

    {# Filtres AvancÃ©s #}
    <div class="filters-container">
        <form method="GET" action="{{ path('app_admin_logs_index') }}" class="filters-form">
            <div class="filter-group">
                <label for="role">ðŸ”½ RÃ´le</label>
                <select name="role" id="role">
                    <option value="">Tous les rÃ´les</option>
                    <option value="ROLE_ADMIN" {{ filters.role == 'ROLE_ADMIN' ? 'selected' : '' }}>Admin</option>
                    <option value="ROLE_COACH" {{ filters.role == 'ROLE_COACH' ? 'selected' : '' }}>Coach</option>
                    <option value="ROLE_SPECIALISTE" {{ filters.role == 'ROLE_SPECIALISTE' ? 'selected' : '' }}>SpÃ©cialiste</option>
                    <option value="ROLE_USER" {{ filters.role == 'ROLE_USER' ? 'selected' : '' }}>Utilisateur</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="action_type">ðŸ”½ Type d'action</label>
                <select name="action_type" id="action_type">
                    <option value="">Toutes les actions</option>
                    <option value="login" {{ filters.action_type == 'login' ? 'selected' : '' }}>ðŸŸ¢ Connexion rÃ©ussie</option>
                    <option value="logout" {{ filters.action_type == 'logout' ? 'selected' : '' }}>ðŸ”µ DÃ©connexion</option>
                    <option value="failed" {{ filters.action_type == 'failed' ? 'selected' : '' }}>ðŸ”´ Connexion Ã©chouÃ©e</option>
                    <option value="password" {{ filters.action_type == 'password' ? 'selected' : '' }}>ðŸŸ£ Changement de mot de passe</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="date_from">ðŸ“… Date de dÃ©but</label>
                <input type="date" name="date_from" id="date_from" value="{{ filters.date_from }}" max="{{ "now"|date('Y-m-d') }}">
            </div>

            <div class="filter-group">
                <label for="date_to">ðŸ“… Date de fin</label>
                <input type="date" name="date_to" id="date_to" value="{{ filters.date_to }}" max="{{ "now"|date('Y-m-d') }}">
            </div>

            <div class="filter-buttons">
                <button type="submit" class="btn-filter">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 5px;">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filtrer
                </button>
                <a href="{{ path('app_admin_logs_index') }}" class="btn-reset">RÃ©initialiser</a>
            </div>
        </form>
    </div>

    {# Recherche Dynamique #}
    <div class="search-bar-container" style="margin-bottom: 25px; display: flex; align-items: center; background: white; padding: 10px 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a0aec0" stroke-width="2" style="margin-right: 10px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        <input type="text" id="logSearchInput" placeholder="Rechercher par utilisateur, email ou action..." style="border: none; outline: none; width: 100%; font-size: 15px; background: transparent;">
    </div>

    <div class="card">
        <div class="table-responsive">
            <table class="table" id="logsTable">
                <thead>
                    <tr>
                        <th style="cursor: pointer;" onclick="sortTable(0)">Date & Heure â†•</th>
                        <th style="cursor: pointer;" onclick="sortTable(1)">Utilisateur â†•</th>
                        <th style="cursor: pointer;" onclick="sortTable(2)">RÃ´le â†•</th>
                        <th style="cursor: pointer;" onclick="sortTable(3)">Action â†•</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in logs %}
                    <tr class="log-row">
                        <td class="log-date">{{ log.createdAt|date('d/m/Y H:i:s') }}</td>
                        <td class="log-user">
                            {% if log.utilisateur %}
                                <strong>{{ log.utilisateur.nomComplet }}</strong><br>
                                <small style="color: #718096;">{{ log.utilisateur.email }}</small>
                            {% else %}
                                <span style="color: #a0aec0; font-style: italic;">SystÃ¨me / Anonyme</span>
                            {% endif %}
                        </td>
                        <td class="log-role">
                            {% if log.utilisateur and log.utilisateur.roles|length > 0 %}
                                {% set role = log.utilisateur.roles|first %}
                                {% if 'ROLE_ADMIN' in role %}
                                    <span class="badge-role badge-role-admin">{{ role }}</span>
                                {% elseif 'ROLE_COACH' in role %}
                                    <span class="badge-role badge-role-coach">{{ role }}</span>
                                {% elseif 'ROLE_SPECIALISTE' in role %}
                                    <span class="badge-role badge-role-specialist">{{ role }}</span>
                                {% else %}
                                    <span class="badge-role badge-role-user">{{ role }}</span>
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="log-action">
                            {% if 'Connexion rÃ©ussie' in log.action %}
                                <span class="badge-login">ðŸŸ¢ {{ log.action }}</span>
                            {% elseif 'DÃ©connexion' in log.action %}
                                <span class="badge-logout">ðŸ”µ {{ log.action }}</span>
                            {% elseif 'Ã©chouÃ©e' in log.action or 'failed' in log.action|lower %}
                                <span class="badge-failed">ðŸ”´ {{ log.action }}</span>
                            {% elseif 'mot de passe' in log.action|lower or 'password' in log.action|lower %}
                                <span class="badge-password">ðŸŸ£ {{ log.action }}</span>
                            {% else %}
                                <span class="badge-default">âšª {{ log.action }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 30px; color: #718096;">Aucun journal d'activitÃ© trouvÃ©.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // Filtrage dynamique (Recherche)
    document.getElementById('logSearchInput').addEventListener('keyup', function() {
        let filter = this.value.toLowerCase();
        let rows = document.querySelectorAll('.log-row');

        rows.forEach(row => {
            let userText = row.querySelector('.log-user').textContent.toLowerCase();
            let actionText = row.querySelector('.log-action').textContent.toLowerCase();
            
            if (userText.includes(filter) || actionText.includes(filter)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });

    // Tri dynamique du tableau par clic sur les en-tÃªtes
    function sortTable(columnIndex) {
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("logsTable");
        switching = true;
        dir = "asc"; 
        
        while (switching) {
            switching = false;
            rows = table.rows;
            
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[columnIndex];
                y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
                
                let valX = x.textContent.trim().toLowerCase();
                let valY = y.textContent.trim().toLowerCase();

                if (dir == "asc") {
                    if (valX > valY) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir == "desc") {
                    if (valX < valY) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount ++;      
            } else {
                if (switchcount == 0 && dir == "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
    }
</script>
{% endblock %}
