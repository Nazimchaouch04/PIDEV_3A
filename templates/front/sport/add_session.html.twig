{# BioSync Sport Module - Add Session Form
# Front Office - Add New Sport Session
#}

{% extends 'front/base.html.twig' %}

{% block title %}Ajouter une s√©ance - BioSync{% endblock %}

{% block content %}
<div class="container py-8 max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="{{ path('app_sport_sessions') }}" class="text-blue-600 hover:text-blue-500 mr-3">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900 font-heading">
                Nouvelle S√©ance Sport
            </h1>
        </div>
        <p class="text-gray-600">
            Enregistrez votre s√©ance pour suivre vos progr√®s et atteindre vos objectifs
        </p>
    </div>

    <!-- Quick Start Templates -->
    {% include 'components/_card.html.twig' with {
        'title': 'D√©marrage Rapide',
        'subtitle': 'Choisissez un mod√®le de s√©ance pr√©d√©fini'
    } %}
    {% block card_body %}
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <button class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-center session-template" 
                    onclick="applyTemplate('cardio', 'Cardio Mod√©r√©', 30, 'moderate')">
                <i class="fas fa-running text-blue-500 text-2xl mb-3"></i>
                <h4 class="font-medium">Cardio Rapide</h4>
                <p class="text-sm text-gray-600">30 min ‚Ä¢ Mod√©r√©</p>
                <p class="text-xs text-gray-500 mt-1">250 cal estim√©es</p>
            </button>
            
            <button class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-center session-template" 
                    onclick="applyTemplate('strength', 'Musculation Compl√®te', 45, 'high')">
                <i class="fas fa-dumbbell text-green-500 text-2xl mb-3"></i>
                <h4 class="font-medium">Full Body</h4>
                <p class="text-sm text-gray-600">45 min ‚Ä¢ Intense</p>
                <p class="text-xs text-gray-500 mt-1">400 cal estim√©es</p>
            </button>
            
            <button class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 text-center session-template" 
                    onclick="applyTemplate('flexibility', 'Yoga Doux', 20, 'low')">
                <i class="fas fa-spa text-purple-500 text-2xl mb-3"></i>
                <h4 class="font-medium">Yoga Relaxation</h4>
                <p class="text-sm text-gray-600">20 min ‚Ä¢ L√©ger</p>
                <p class="text-xs text-gray-500 mt-1">100 cal estim√©es</p>
            </button>
        </div>
    {% endblock %}
    {% endinclude %}

    <!-- Main Session Form -->
    {% include 'components/_card.html.twig' with {
        'title': 'D√©tails de la S√©ance',
        'variant': 'default'
    } %}
    {% block card_body %}
        {% include 'components/_form.html.twig' with {
            'action': path('app_sport_add_session'),
            'method': 'POST',
            'fields': [
                {
                    'name': 'session_type',
                    'type': 'select',
                    'label': 'Type de s√©ance *',
                    'required': true,
                    'options': [
                        {'value': 'cardio', 'label': 'üèÉ Cardio'},
                        {'value': 'strength', 'label': 'üí™ Musculation'},
                        {'value': 'flexibility', 'label': 'üßò Flexibilit√©/Yoga'},
                        {'value': 'sports', 'label': '‚öΩ Sports'},
                        {'value': 'outdoor', 'label': 'üå≥ Plein air'},
                        {'value': 'other', 'label': 'üìù Autre'}
                    ]
                },
                {
                    'name': 'session_name',
                    'type': 'text',
                    'label': 'Nom de la s√©ance *',
                    'placeholder': 'Ex: Course matinale, Haut du corps, Yoga flow...',
                    'required': true
                },
                {
                    'name': 'scheduled_date',
                    'type': 'text',
                    'label': 'Date',
                    'placeholder': 'JJ/MM/AAAA',
                    'value': "now"|date("d/m/Y"),
                    'help': 'Laissez vide pour la date actuelle'
                },
                {
                    'name': 'scheduled_time',
                    'type': 'text',
                    'label': 'Heure',
                    'placeholder': 'HH:MM',
                    'value': "now"|date("H:i"),
                    'help': 'Laissez vide pour l\'heure actuelle'
                }
            ],
            'submit_text': '',
            'submit_variant': 'primary'
        } %}
        
        <!-- Duration and Intensity -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div>
                {% include 'components/_form.html.twig' with {
                    'action': '',
                    'method': 'POST',
                    'fields': [
                        {
                            'name': 'duration',
                            'type': 'text',
                            'label': 'Dur√©e (minutes) *',
                            'placeholder': '45',
                            'required': true,
                            'help': 'Minimum 5 minutes'
                        }
                    ],
                    'submit_text': '',
                    'submit_variant': 'primary'
                } %}
            </div>
            
            <div>
                {% include 'components/_form.html.twig' with {
                    'action': '',
                    'method': 'POST',
                    'fields': [
                        {
                            'name': 'intensity',
                            'type': 'select',
                            'label': 'Intensit√© *',
                            'required': true,
                            'options': [
                                {'value': 'low', 'label': 'üå± L√©ger (peine √† parler)'},
                                {'value': 'moderate', 'label': 'üåø Mod√©r√© (peut parler)'},
                                {'value': 'high', 'label': 'üî• Intense (difficile de parler)'},
                                {'value': 'very_high', 'label': '‚ö° Tr√®s intense (ne peut pas parler)'}
                            ]
                        }
                    ],
                    'submit_text': '',
                    'submit_variant': 'primary'
                } %}
            </div>
        </div>
        
        <!-- Calories and Metrics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
            <div>
                {% include 'components/_form.html.twig' with {
                    'action': '',
                    'method': 'POST',
                    'fields': [
                        {
                            'name': 'calories_burned',
                            'type': 'text',
                            'label': 'Calories br√ªl√©es',
                            'placeholder': 'Auto',
                            'help': 'Laissez vide pour calculer automatiquement'
                        }
                    ],
                    'submit_text': '',
                    'submit_variant': 'primary'
                } %}
            </div>
            
            <div>
                {% include 'components/_form.html.twig' with {
                    'action': '',
                    'method': 'POST',
                    'fields': [
                        {
                            'name': 'distance',
                            'type': 'text',
                            'label': 'Distance (km)',
                            'placeholder': '5.5',
                            'help': 'Pour les s√©ances de course/v√©lo'
                        }
                    ],
                    'submit_text': '',
                    'submit_variant': 'primary'
                } %}
            </div>
            
            <div>
                {% include 'components/_form.html.twig' with {
                    'action': '',
                    'method': 'POST',
                    'fields': [
                        {
                            'name': 'heart_rate_avg',
                            'type': 'text',
                            'label': 'Fr√©quence cardiaque moyenne',
                            'placeholder': '145',
                            'help': 'En battements par minute'
                        }
                    ],
                    'submit_text': '',
                    'submit_variant': 'primary'
                } %}
            </div>
        </div>
        
        <!-- Exercises Section (for strength training) -->
        <div id="exercisesSection" class="mt-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">Exercices</h3>
                {% include 'components/_button.html.twig' with {
                    'text': 'Ajouter un exercice',
                    'variant': 'outline',
                    'size': 'sm',
                    'icon': 'fas fa-plus',
                    'onclick': 'addExercise()'
                } %}
            </div>
            
            <div id="exercisesList" class="space-y-3">
                <!-- Exercises will be added here dynamically -->
            </div>
        </div>
        
        <!-- Session Notes -->
        <div class="mt-6">
            {% include 'components/_form.html.twig' with {
                'action': '',
                'method': 'POST',
                'fields': [
                    {
                        'name': 'notes',
                        'type': 'textarea',
                        'label': 'Notes de s√©ance',
                        'placeholder': 'Exercices r√©alis√©s, sensations, difficult√©s, objectifs atteints...',
                        'help': 'D√©crivez votre s√©ance pour un meilleur suivi'
                    },
                    {
                        'name': 'mood_before',
                        'type': 'select',
                        'label': '√ânergie avant la s√©ance',
                        'options': [
                            {'value': '', 'label': 'Non sp√©cifi√©'},
                            {'value': 'very_energetic', 'label': 'Tr√®s √©nergique'},
                            {'value': 'energetic', 'label': '√ânergique'},
                            {'value': 'neutral', 'label': 'Neutre'},
                            {'value': 'tired', 'label': 'Fatigu√©'},
                            {'value': 'very_tired', 'label': 'Tr√®s fatigu√©'}
                        ]
                    },
                    {
                        'name': 'mood_after',
                        'type': 'select',
                        'label': 'Sensations apr√®s la s√©ance',
                        'options': [
                            {'value': '', 'label': 'Non sp√©cifi√©'},
                            {'value': 'great', 'label': 'Excellent'},
                            {'value': 'good', 'label': 'Bien'},
                            {'value': 'normal', 'label': 'Normal'},
                            {'value': 'difficult', 'label': 'Difficile'},
                            {'value': 'exhausted', 'label': '√âpuis√©'}
                        ]
                    }
                ],
                'submit_text': '',
                'submit_variant': 'primary'
            } %}
        </div>
        
        <!-- Session Summary -->
        <div class="mt-6 p-4 bg-blue-50 rounded-lg">
            <h4 class="font-semibold mb-3">R√©sum√© estim√©</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                <div>
                    <span class="text-gray-600">Calories:</span>
                    <span class="font-medium ml-1" id="estimatedCalories">--</span>
                </div>
                <div>
                    <span class="text-gray-600">Dur√©e:</span>
                    <span class="font-medium ml-1" id="totalDuration">--</span>
                </div>
                <div>
                    <span class="text-gray-600">Intensit√©:</span>
                    <span class="font-medium ml-1" id="intensityLevel">--</span>
                </div>
                <div>
                    <span class="text-gray-600">Type:</span>
                    <span class="font-medium ml-1" id="sessionTypeDisplay">--</span>
                </div>
            </div>
        </div>
        
        <!-- Form Actions -->
        <div class="mt-8 flex gap-3">
            {% include 'components/_button.html.twig' with {
                'text': 'D√©marrer la s√©ance',
                'variant': 'primary',
                'type': 'submit',
                'icon': 'fas fa-play'
            } %}
            
            {% include 'components/_button.html.twig' with {
                'text': 'Planifier plus tard',
                'variant': 'outline',
                'icon': 'fas fa-calendar'
            } %}
            
            {% include 'components/_button.html.twig' with {
                'text': 'Annuler',
                'variant': 'soft',
                'href': path('app_sport_sessions')
            } %}
        </div>
    {% endblock %}
    {% endinclude %}
</div>

<!-- Exercise Search Modal -->
{% include 'components/_modal.html.twig' with {
    'id': 'exerciseModal',
    'title': 'Rechercher un exercice',
    'size': 'lg'
} %}
{% block modal_content %}
    <div class="space-y-4">
        <div class="relative">
            <input type="text" 
                   class="form-input pl-10" 
                   placeholder="Rechercher un exercice..."
                   id="exerciseSearchInput">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
        
        <div id="exerciseSearchResults" class="space-y-2 max-h-96 overflow-y-auto">
            <!-- Exercise categories -->
            <div class="grid grid-cols-2 gap-3">
                <button class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left" 
                        onclick="selectExercise('D√©velopp√© couch√©', 'pectoraux')">
                    <h4 class="font-medium">D√©velopp√© couch√©</h4>
                    <p class="text-sm text-gray-600">Pectoraux ‚Ä¢ Force</p>
                </button>
                
                <button class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left" 
                        onclick="selectExercise('Squat', 'jambes')">
                    <h4 class="font-medium">Squat</h4>
                    <p class="text-sm text-gray-600">Jambes ‚Ä¢ Force</p>
                </button>
                
                <button class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left" 
                        onclick="selectExercise('Tractions', 'dos')">
                    <h4 class="font-medium">Tractions</h4>
                    <p class="text-sm text-gray-600">Dos ‚Ä¢ Force</p>
                </button>
                
                <button class="p-3 border border-gray-200 rounded-lg hover:bg-gray-50 text-left" 
                        onclick="selectExercise('D√©velopp√© militaire', '√©paules')">
                    <h4 class="font-medium">D√©velopp√© militaire</h4>
                    <p class="text-sm text-gray-600">√âpaules ‚Ä¢ Force</p>
                </button>
            </div>
        </div>
    </div>
{% endblock %}
{% endmodal_content %}
{% endinclude %}
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form interactions
    initializeFormInteractions();
    
    // Initialize exercise search
    initializeExerciseSearch();
    
    // Calculate initial estimates
    updateSessionSummary();
});

function initializeFormInteractions() {
    // Show/hide exercises section based on session type
    const sessionTypeSelect = document.querySelector('select[name="session_type"]');
    const exercisesSection = document.getElementById('exercisesSection');
    
    sessionTypeSelect?.addEventListener('change', function() {
        if (this.value === 'strength') {
            exercisesSection.classList.remove('hidden');
        } else {
            exercisesSection.classList.add('hidden');
        }
        updateSessionSummary();
    });
    
    // Update summary when form fields change
    const formInputs = document.querySelectorAll('input, select');
    formInputs.forEach(input => {
        input.addEventListener('input', updateSessionSummary);
        input.addEventListener('change', updateSessionSummary);
    });
    
    // Auto-calculate calories
    const durationInput = document.querySelector('input[name="duration"]');
    const intensitySelect = document.querySelector('select[name="intensity"]');
    const caloriesInput = document.querySelector('input[name="calories_burned"]');
    
    function autoCalculateCalories() {
        if (!caloriesInput.value && durationInput.value && intensitySelect.value) {
            const duration = parseInt(durationInput.value) || 0;
            const intensity = intensitySelect.value;
            const estimated = estimateCalories(duration, intensity);
            caloriesInput.placeholder = estimated.toString();
        }
    }
    
    durationInput?.addEventListener('input', autoCalculateCalories);
    intensitySelect?.addEventListener('change', autoCalculateCalories);
}

function updateSessionSummary() {
    const sessionType = document.querySelector('select[name="session_type"]')?.value;
    const duration = document.querySelector('input[name="duration"]')?.value;
    const intensity = document.querySelector('select[name="intensity"]')?.value;
    const calories = document.querySelector('input[name="calories_burned"]')?.value;
    
    // Update session type display
    const typeLabels = {
        'cardio': 'Cardio',
        'strength': 'Musculation',
        'flexibility': 'Flexibilit√©',
        'sports': 'Sports',
        'outdoor': 'Plein air',
        'other': 'Autre'
    };
    document.getElementById('sessionTypeDisplay').textContent = typeLabels[sessionType] || '--';
    
    // Update duration
    document.getElementById('totalDuration').textContent = duration ? duration + ' min' : '--';
    
    // Update intensity
    const intensityLabels = {
        'low': 'L√©ger',
        'moderate': 'Mod√©r√©',
        'high': 'Intense',
        'very_high': 'Tr√®s intense'
    };
    document.getElementById('intensityLevel').textContent = intensityLabels[intensity] || '--';
    
    // Update calories
    if (calories) {
        document.getElementById('estimatedCalories').textContent = calories + ' cal';
    } else if (duration && intensity) {
        const estimated = estimateCalories(parseInt(duration), intensity);
        document.getElementById('estimatedCalories').textContent = '~' + estimated + ' cal';
    } else {
        document.getElementById('estimatedCalories').textContent = '--';
    }
}

function estimateCalories(duration, intensity) {
    const baseCalories = {
        'low': 5,
        'moderate': 8,
        'high': 12,
        'very_high': 15
    };
    
    return Math.round(duration * (baseCalories[intensity] || 8));
}

function applyTemplate(type, name, duration, intensity) {
    // Fill form with template data
    document.querySelector('select[name="session_type"]').value = type;
    document.querySelector('input[name="session_name"]').value = name;
    document.querySelector('input[name="duration"]').value = duration;
    document.querySelector('select[name="intensity"]').value = intensity;
    
    // Show exercises section for strength training
    if (type === 'strength') {
        document.getElementById('exercisesSection').classList.remove('hidden');
    }
    
    // Update summary
    updateSessionSummary();
    
    // Scroll to form
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
    
    // Show confirmation
    showAlert('Mod√®le appliqu√© avec succ√®s', 'success');
}

function addExercise() {
    openModal_exerciseModal();
}

function initializeExerciseSearch() {
    const searchInput = document.getElementById('exerciseSearchInput');
    
    searchInput?.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        // This would search in exercise database
        console.log('Searching for:', query);
    });
}

function selectExercise(name, muscleGroup) {
    const exercisesList = document.getElementById('exercisesList');
    const exerciseItem = document.createElement('div');
    exerciseItem.className = 'exercise-item p-4 border border-gray-200 rounded-lg';
    exerciseItem.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div class="md:col-span-2">
                <label class="form-label">Exercice</label>
                <input type="text" 
                       name="exercises[]" 
                       class="form-input" 
                       value="${name}"
                       readonly>
            </div>
            <div>
                <label class="form-label">S√©ries</label>
                <input type="number" 
                       name="sets[]" 
                       class="form-input" 
                       placeholder="3"
                       min="1"
                       max="10">
            </div>
            <div>
                <label class="form-label">R√©p√©titions</label>
                <input type="number" 
                       name="reps[]" 
                       class="form-input" 
                       placeholder="12"
                       min="1"
                       max="100">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <div>
                <label class="form-label">Poids (kg)</label>
                <input type="number" 
                       name="weights[]" 
                       class="form-input" 
                       placeholder="20"
                       min="0"
                       step="0.5">
            </div>
            <div>
                <label class="form-label">Repos (sec)</label>
                <input type="number" 
                       name="rest[]" 
                       class="form-input" 
                       placeholder="60"
                       min="0"
                       max="300">
            </div>
            <div>
                <label class="form-label">Notes</label>
                <input type="text" 
                       name="exercise_notes[]" 
                       class="form-input" 
                       placeholder="Technique, sensations...">
            </div>
        </div>
        <div class="mt-3 flex justify-end">
            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeExercise(this)">
                <i class="fas fa-trash"></i> Supprimer
            </button>
        </div>
    `;
    
    exercisesList.appendChild(exerciseItem);
    closeModal_exerciseModal();
    showAlert('Exercice ajout√©', 'success');
}

function removeExercise(button) {
    const exerciseItem = button.closest('.exercise-item');
    exerciseItem.remove();
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    form?.addEventListener('submit', function(e) {
        const duration = document.querySelector('input[name="duration"]').value;
        const sessionType = document.querySelector('select[name="session_type"]').value;
        
        if (!duration || duration < 5) {
            e.preventDefault();
            showAlert('La dur√©e doit √™tre d\'au moins 5 minutes', 'error');
            return;
        }
        
        if (sessionType === 'strength') {
            const exercises = document.querySelectorAll('.exercise-item');
            if (exercises.length === 0) {
                e.preventDefault();
                showAlert('Veuillez ajouter au moins un exercice pour la musculation', 'error');
                return;
            }
        }
        
        // Auto-calculate calories if empty
        const caloriesInput = document.querySelector('input[name="calories_burned"]');
        if (!caloriesInput.value) {
            const duration = parseInt(document.querySelector('input[name="duration"]').value) || 0;
            const intensity = document.querySelector('select[name="intensity"]').value;
            caloriesInput.value = estimateCalories(duration, intensity);
        }
        
        showAlert('S√©ance enregistr√©e avec succ√®s !', 'success');
    });
});
</script>
{% endblock %}
