{% extends 'base_back.html.twig' %}

{% block title %}{{ title }}{% endblock %}

{% block body %}
    <div class="page-header">
        <h1 class="page-title">{{ title }}</h1>
    </div>

    <div class="card" style="max-width: 700px;">
        {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}
            
            <div class="form-group">
                <label class="form-label">Group Name</label>
                {{ form_widget(form.nomGroupe, {'attr': {'class': 'form-control'}}) }}
            </div>

            <div class="form-group">
                <label class="form-label">Theme</label>
                {{ form_widget(form.thematique, {'attr': {'class': 'form-control'}}) }}
            </div>

            <!-- AI IMAGE GENERATION SECTION -->
            <div class="form-group">
                <label class="form-label">Group Image</label>
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    {{ form_widget(form.image, {'attr': {'class': 'form-control', 'placeholder': 'Paste URL or Generate with AI'}}) }}
                    <button type="button" id="btn-ai-image" class="btn btn-secondary" style="white-space: nowrap; background: #10b981; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        üé® G√©n√©rer Image IA
                    </button>
                </div>
                
                <!-- Image Preview Area -->
                <div id="ai-image-preview" style="display: none; margin-top: 15px; text-align: center; border: 2px dashed #10b981; padding: 10px; border-radius: 8px;">
                    <p style="font-size: 12px; color: #059669; font-weight: bold; margin-bottom: 8px;">‚ú® Image g√©n√©r√©e avec succ√®s !</p>
                    <img id="preview-img-tag" src="" style="width: 100%; height: 250px; object-fit: cover; border-radius: 6px;">
                </div>
                <small id="image-loader" style="display: none; color: #10b981; font-weight: bold;">üé® BioSync AI dessine votre image (environ 15-20s)...</small>
            </div>

            <div class="form-group">
                <label class="form-label">Capacity</label>
                {{ form_widget(form.capaciteMax, {'attr': {'class': 'form-control'}}) }}
            </div>

            <div class="form-group">
                <label class="form-label">Description</label>
                <div style="display: flex; gap: 10px; margin-bottom: 5px; align-items: flex-start;">
                    <div style="flex: 1;">
                        {{ form_widget(form.description, {'attr': {'class': 'form-control', 'rows': 4}}) }}
                    </div>
                    <button type="button" id="btn-ai-generate" class="btn btn-secondary" style="white-space: nowrap; background: #4f46e5; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ‚ú® Texte IA
                    </button>
                </div>
                <small id="ai-loader" style="display: none; color: #4f46e5; font-weight: bold;">üß¨ R√©daction en cours...</small>
            </div>

            <div style="margin-top: 24px;">
                <button type="submit" class="btn btn-primary">Save Community</button>
                <a href="{{ path('app_admin_community_index') }}" class="btn btn-outline">Cancel</a>
            </div>

        {{ form_end(form) }}
    </div>
{% endblock %}

{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const aiTextBtn = document.getElementById('btn-ai-generate');
    const aiImgBtn = document.getElementById('btn-ai-image');
    
    // --- TEXT GENERATION LOGIC ---
    aiTextBtn.addEventListener('click', async function() {
        const nameInput = document.getElementById('{{ form.nomGroupe.vars.id }}');
        const themeInput = document.getElementById('{{ form.thematique.vars.id }}');
        const descField = document.getElementById('{{ form.description.vars.id }}');
        const loader = document.getElementById('ai-loader');

        if (!nameInput.value || !themeInput.value) {
            alert('Veuillez remplir le Nom et la Th√©matique !'); return;
        }

        loader.style.display = 'block';
        loader.textContent = 'üß¨ G√©n√©ration en cours...';
        this.disabled = true;

        try {
            const response = await fetch('{{ path('app_admin_ai_generate') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: nameInput.value, theme: themeInput.value })
            });
            
            if (!response.ok) {
                throw new Error('Erreur r√©seau');
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            if (data.description && data.description.length > 20) {
                descField.value = data.description;
                loader.textContent = '‚ú® Description g√©n√©r√©e !';
                setTimeout(() => { loader.style.display = 'none'; }, 1000);
            } else {
                throw new Error('Description trop courte');
            }
        } catch (e) {
            alert('Erreur: ' + e.message);
            loader.style.display = 'none';
        } finally {
            this.disabled = false;
        }
    });

    // --- IMAGE GENERATION LOGIC ---
    aiImgBtn.addEventListener('click', async function() {
        const themeInput = document.getElementById('{{ form.thematique.vars.id }}');
        const urlField = document.getElementById('{{ form.image.vars.id }}');
        const loader = document.getElementById('image-loader');
        const previewDiv = document.getElementById('ai-image-preview');
        const previewImg = document.getElementById('preview-img-tag');

        if (!themeInput.value) {
            alert('Veuillez saisir une th√©matique d\'abord !'); return;
        }

        loader.style.display = 'block';
        previewDiv.style.display = 'none';
        this.disabled = true;
        this.innerText = "‚è≥ G√©n√©ration...";

        try {
            const response = await fetch('{{ path('app_admin_ai_image') }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme: themeInput.value })
            });

            if (!response.ok) {
                throw new Error('Erreur r√©seau ou mod√®le indisponible');
            }

            const data = await response.json();

            if (data.image) {
                const isTextPlaceholder = data.image.includes('üßò') || 
                                           data.image.includes('üí™') ||
                                           data.image.includes('ü•ó') ||
                                           data.image.includes('üß†') ||
                                           data.image.includes('üåü');
                
                if (isTextPlaceholder) {
                    previewDiv.style.display = 'block';
                    previewDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    previewDiv.style.color = 'white';
                    previewDiv.style.alignItems = 'center';
                    previewDiv.style.justifyContent = 'center';
                    previewDiv.style.fontSize = '24px';
                    previewDiv.style.fontWeight = 'bold';
                    previewDiv.style.textAlign = 'center';
                    previewDiv.style.padding = '20px';
                    previewDiv.innerHTML = data.image;
                    urlField.value = ''; 
                } else {
                    // Handle both Unsplash URLs and AI-generated base64 images
                    if (data.image.startsWith('http')) {
                        urlField.value = data.image;
                        previewImg.src = data.image;
                        previewDiv.style.display = 'block';
                        previewDiv.style.background = '';
                    } else {
                        const base64String = 'data:image/png;base64,' + data.image;
                        urlField.value = base64String;
                        previewImg.src = base64String;
                        previewDiv.style.display = 'block';
                        previewDiv.style.background = '';
                    }
                }
                loader.style.display = 'none';
                this.innerText = "üé® G√©n√©rer Image IA";
            } else {
                throw new Error(data.error || '√âchec de la g√©n√©ration');
            }
        } catch (e) {
            alert('Erreur: ' + e.message + '\nConseil: Essayez avec une autre th√©matique ou r√©essayez plus tard.');
        } finally {
            this.disabled = false;
            if (loader.style.display !== 'none') {
                loader.style.display = 'none';
                this.innerText = "üé® G√©n√©rer Image IA";
            }
        }
    });
});
</script>
{% endblock %}