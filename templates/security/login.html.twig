{% extends 'base.html.twig' %}

{% block title %}Connexion - BioSync{% endblock %}

{% block body %}
<div class="modern-auth-wrapper">
    <div class="modern-auth-container">
        {# Logo et titre #}
        <div class="modern-auth-header">
            <div class="modern-auth-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <circle cx="12" cy="8" r="7"/>
                    <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/>
                </svg>
            </div>
            <h1 class="modern-auth-brand">BioSync</h1>
            <p class="modern-auth-tagline">Connectez-vous pour accÃ©der Ã  votre espace santÃ©</p>
        </div>

        {# Carte formulaire #}
        <div class="modern-auth-card">
            <h2 class="modern-auth-form-title">Connexion</h2>

            {% if premium_flow is defined and premium_flow %}
                <div class="modern-premium-alert">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 20px; height: 20px; margin-right: 8px;">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    Connectez-vous pour accÃ©der Ã  la certification Premium
                </div>
            {% endif %}

            {% if error %}
                <div class="modern-error-alert">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="15" y1="9" x2="9" y2="15"/>
                        <line x1="9" y1="9" x2="15" y2="15"/>
                    </svg>
                    {{ error.messageKey|trans(error.messageData, 'security') }}
                </div>
            {% endif %}

            {# HTML5 validation disabled - using Symfony validators instead #}
            <form method="post" action="{{ path('app_login') }}" class="modern-auth-form" novalidate>
                <!-- Champ cachÃ© pour reCAPTCHA -->
                <input type="hidden" id="recaptcha-response" name="recaptcha_response">
                
                {# Email #}
                <div class="modern-form-group">
                    <label for="_username" class="modern-form-label">Adresse email</label>
                    <div class="modern-input-wrapper">
                        <svg class="modern-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        {# HTML5 validation disabled - using Symfony validators instead #}
                        {# HTML5 type=email disabled - using Symfony Email validator instead #}
                        <input type="text" id="_username" name="_username" value="{{ last_username }}" class="modern-input" placeholder="votre@email.com" {# required autofocus #}>
                    </div>
                </div>

                {# Mot de passe #}
                <div class="modern-form-group">
                    <label for="_password" class="modern-form-label">Mot de passe</label>
                    <div class="modern-input-wrapper">
                        <svg class="modern-input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            <circle cx="12" cy="16" r="1"/>
                        </svg>
                        <input type="password" id="_password" name="_password" class="modern-input" placeholder="Votre mot de passe" {# required #}>
                        <button type="button" id="toggle-password" class="password-toggle">
                            <svg id="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 20px; height: 20px;">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <svg id="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width: 20px; height: 20px; display: none;">
                                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                                <line x1="1" y1="1" x2="23" y2="23"/>
                            </svg>
                        </button>
                    </div>
                </div>

                {# Remember me #}
                <div class="modern-checkbox-wrapper" style="padding: 12px;">
                    <input type="checkbox" id="remember_me" name="_remember_me">
                    <label for="remember_me">Se souvenir de moi</label>
                </div>

                {# CSRF token (keep this) #}
                <input type="hidden" name="_csrf_token" value="{{ csrf_token('authenticate') }}">

                {# Bouton submit avec gradient #}
                <button type="submit" class="modern-btn-gradient">
                    Se connecter
                </button>
            </form>

            {# Lien inscription #}
            <div class="modern-auth-footer">
                Pas encore de compte? <a href="{{ path('app_register') }}">S'inscrire</a>
            </div>
            
            {# Lien mot de passe oubliÃ© #}
            <div class="modern-forgot-password">
                <a href="{{ path('app_forgot_password') }}" class="forgot-password-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        <circle cx="12" cy="16" r="1"/>
                    </svg>
                    Mot de passe oubliÃ©?
                </a>
            </div>

            {# â”€â”€â”€ Face ID Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
            <div class="faceid-divider">
                <div class="faceid-divider-line"></div>
                <span class="faceid-divider-text">Ou</span>
                <div class="faceid-divider-line"></div>
            </div>

            <div class="faceid-section">
                <p class="faceid-label">Utilisez votre Face ID<br>pour vous connecter Ã  votre compte</p>
                <button type="button" id="btn-face-id" class="faceid-btn" title="Se connecter avec Face ID">
                    <svg viewBox="0 0 100 100" class="faceid-icon" fill="none">
                        {# Corner brackets #}
                        <path d="M10 30 L10 10 L30 10" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M70 10 L90 10 L90 30" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M90 70 L90 90 L70 90" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M30 90 L10 90 L10 70" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                        {# Face eyes #}
                        <circle cx="35" cy="43" r="4" fill="currentColor"/>
                        <circle cx="65" cy="43" r="4" fill="currentColor"/>
                        {# Face nose #}
                        <path d="M50 45 L50 58" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                        {# Face smile #}
                        <path d="M36 67 Q50 80 64 67" stroke="currentColor" stroke-width="4" stroke-linecap="round" fill="none"/>
                    </svg>
                </button>
            </div>
            {# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}

        </div>

        {# Copyright footer #}
        <div class="modern-auth-copyright">
            Â© 2026 BioSync - SantÃ©, Science & Bien-Ãªtre
        </div>
    </div>
</div>

{# â•â•â•â•â•â•â• Face ID Modal â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
<div id="faceid-modal" class="faceid-modal" style="display:none;">
    <div class="faceid-modal-overlay" id="faceid-modal-close-bg"></div>
    <div class="faceid-modal-box">

        {# â”€ Step 1: Enter email â”€ #}
        <div id="faceid-email-step">
            <button class="faceid-close-btn" id="faceid-close">&times;</button>
            <div class="faceid-logo">
                <svg viewBox="0 0 100 100" fill="none" style="width:60px;height:60px;color:var(--primary,#4caf50)">
                    <path d="M10 30 L10 10 L30 10" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M70 10 L90 10 L90 30" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M90 70 L90 90 L70 90" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M30 90 L10 90 L10 70" stroke="currentColor" stroke-width="5" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="35" cy="43" r="4" fill="currentColor"/>
                    <circle cx="65" cy="43" r="4" fill="currentColor"/>
                    <path d="M50 45 L50 58" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
                    <path d="M36 67 Q50 80 64 67" stroke="currentColor" stroke-width="4" stroke-linecap="round" fill="none"/>
                </svg>
            </div>
            <h3 class="faceid-modal-title">Face ID</h3>
            <p class="faceid-modal-subtitle">Saisissez votre adresse email pour continuer</p>
            <input type="email" id="faceid-email-input" class="modern-input" placeholder="votre@email.com" style="margin: 12px 0; width:100%;">
            <button id="faceid-email-confirm" class="modern-btn-gradient" style="width:100%;">Continuer</button>
        </div>

        {# â”€ Step 2: Webcam (setup or login) â”€ #}
        <div id="faceid-camera-step" style="display:none;">
            <button class="faceid-close-btn" id="faceid-close-2">&times;</button>
            <h3 class="faceid-modal-title" id="faceid-mode-title">Connexion</h3>
            <p class="faceid-modal-subtitle" id="faceid-mode-subtitle">Regardez la camÃ©ra...</p>

            <div class="faceid-camera-wrapper">
                <video id="faceid-video" autoplay playsinline muted class="faceid-video"></video>
                <div class="faceid-camera-ring">
                    <svg viewBox="0 0 200 200" class="faceid-ring-svg">
                        <circle cx="100" cy="100" r="90" fill="none" stroke="#4caf50" stroke-width="4"
                                stroke-dasharray="565" stroke-dashoffset="565" id="faceid-progress-circle"
                                style="transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease;"/>
                    </svg>
                </div>
            </div>

            {# Setup progress dots (only shown during setup) #}
            <div id="faceid-setup-dots" class="faceid-dots" style="display:none;">
                <div class="faceid-dot" id="dot-0"></div>
                <div class="faceid-dot" id="dot-1"></div>
                <div class="faceid-dot" id="dot-2"></div>
                <div class="faceid-dot" id="dot-3"></div>
                <div class="faceid-dot" id="dot-4"></div>
            </div>

            <p id="faceid-status" class="faceid-status">Positionnez votre visage dans le cercle</p>
            <button id="faceid-capture-btn" class="modern-btn-gradient" style="width:100%;margin-top:10px;">ğŸ“¸ Capturer</button>
        </div>

        {# â”€ Success â”€ #}
        <div id="faceid-success-step" style="display:none; text-align:center;">
            <div style="font-size:48px;margin-bottom:8px;">âœ…</div>
            <h3 class="faceid-modal-title" id="faceid-success-title">ConnectÃ© !</h3>
            <p class="faceid-modal-subtitle" id="faceid-success-msg">Redirection en cours...</p>
        </div>

        {# â”€ Error â”€ #}
        <div id="faceid-error-step" style="display:none; text-align:center;">
            <div style="font-size:48px;margin-bottom:8px;">âŒ</div>
            <h3 class="faceid-modal-title">Visage non reconnu</h3>
            <p class="faceid-modal-subtitle" id="faceid-error-msg">Veuillez rÃ©essayer.</p>
            <button id="faceid-retry-btn" class="modern-btn-gradient" style="width:100%;margin-top:10px;">RÃ©essayer</button>
        </div>
    </div>
</div>

{# â•â•â•â•â•â•â• Face ID CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
<style>
/* â”€â”€â”€ Face ID section (login card) â”€â”€â”€ */
.faceid-divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0 14px;
}
.faceid-divider-line {
    flex: 1;
    height: 1px;
    background: rgba(0,0,0,0.12);
}
.faceid-divider-text {
    color: #999;
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
}
.faceid-section {
    text-align: center;
    padding: 4px 0 12px;
}
.faceid-label {
    color: #555;
    font-size: 13px;
    line-height: 1.5;
    margin-bottom: 12px;
}
.faceid-btn {
    background: none;
    border: 2.5px solid #4caf50;
    border-radius: 50%;
    width: 72px;
    height: 72px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #4caf50;
    transition: all 0.25s ease;
    padding: 14px;
}
.faceid-btn:hover {
    background: rgba(76,175,80,0.1);
    transform: scale(1.08);
    box-shadow: 0 4px 20px rgba(76,175,80,0.3);
}
.faceid-icon {
    width: 100%;
    height: 100%;
}

/* â”€â”€â”€ Modal â”€â”€â”€ */
.faceid-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}
.faceid-modal-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(4px);
}
.faceid-modal-box {
    position: relative;
    background: #fff;
    border-radius: 24px;
    padding: 36px 32px 28px;
    width: 380px;
    max-width: 95vw;
    box-shadow: 0 24px 80px rgba(0,0,0,0.2);
    animation: faceid-in 0.3s ease;
    z-index: 1;
}
@keyframes faceid-in {
    from { opacity:0; transform: scale(0.9) translateY(20px); }
    to   { opacity:1; transform: scale(1)   translateY(0); }
}
.faceid-close-btn {
    position: absolute;
    top: 14px; right: 18px;
    background: none; border: none;
    font-size: 24px; cursor: pointer; color: #aaa;
    line-height: 1;
}
.faceid-close-btn:hover { color: #333; }
.faceid-logo { text-align: center; margin-bottom: 8px; }
.faceid-modal-title {
    font-size: 20px;
    font-weight: 700;
    text-align: center;
    color: #222;
    margin: 0 0 6px;
}
.faceid-modal-subtitle {
    font-size: 13px;
    color: #777;
    text-align: center;
    margin: 0 0 14px;
}

/* â”€â”€â”€ Camera â”€â”€â”€ */
.faceid-camera-wrapper {
    position: relative;
    width: 220px;
    height: 220px;
    margin: 0 auto 12px;
}
.faceid-video {
    width: 220px;
    height: 220px;
    object-fit: cover;
    border-radius: 50%;
    display: block;
}
.faceid-camera-ring {
    position: absolute;
    inset: -8px;
    pointer-events: none;
}
.faceid-ring-svg {
    width: 100%;
    height: 100%;
}

/* â”€â”€â”€ Setup dots â”€â”€â”€ */
.faceid-dots {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin: 8px 0;
}
.faceid-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    background: #ddd;
    transition: background 0.3s ease, transform 0.2s ease;
}
.faceid-dot.captured {
    background: #4caf50;
    transform: scale(1.2);
}
.faceid-status {
    text-align: center;
    font-size: 13px;
    color: #666;
    margin: 6px 0 0;
}
</style>

{# â•â•â•â•â•â•â• Face ID JavaScript â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
<script>
(function () {
    'use strict';

    const TOTAL_SETUP_FRAMES = 5;
    const GENERATE_URL  = '{{ path("api_face_generate_embedding") }}';
    const REGISTER_URL  = '{{ path("api_face_register") }}';
    const STATUS_URL    = '{{ path("api_face_status") }}';
    const LOGIN_URL     = '{{ path("api_face_login") }}';

    // â”€ DOM refs â”€
    const btnFaceId       = document.getElementById('btn-face-id');
    const modal           = document.getElementById('faceid-modal');
    const emailStep       = document.getElementById('faceid-email-step');
    const cameraStep      = document.getElementById('faceid-camera-step');
    const successStep     = document.getElementById('faceid-success-step');
    const errorStep       = document.getElementById('faceid-error-step');
    const emailInput      = document.getElementById('faceid-email-input');
    const confirmBtn      = document.getElementById('faceid-email-confirm');
    const captureBtn      = document.getElementById('faceid-capture-btn');
    const retryBtn        = document.getElementById('faceid-retry-btn');
    const video           = document.getElementById('faceid-video');
    const statusMsg       = document.getElementById('faceid-status');
    const progressCircle  = document.getElementById('faceid-progress-circle');
    const setupDots       = document.getElementById('faceid-setup-dots');
    const modeTitle       = document.getElementById('faceid-mode-title');
    const modeSubtitle    = document.getElementById('faceid-mode-subtitle');
    const successMsg      = document.getElementById('faceid-success-msg');
    const errorMsg        = document.getElementById('faceid-error-msg');
    const successTitle    = document.getElementById('faceid-success-title');

    let stream = null;
    let isSetupMode = false;
    let capturedEncodings = [];
    let currentEmail = '';

    // â”€ Helpers â”€
    function showStep(step) {
        [emailStep, cameraStep, successStep, errorStep].forEach(s => s.style.display = 'none');
        step.style.display = 'block';
    }

    function openModal()  { modal.style.display = 'flex'; showStep(emailStep); emailInput.focus(); }
    function closeModal() { modal.style.display = 'none'; stopCamera(); resetState(); }

    function stopCamera() {
        if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
    }

    function resetState() {
        capturedEncodings = [];
        isSetupMode = false;
        currentEmail = '';
        document.querySelectorAll('.faceid-dot').forEach(d => d.classList.remove('captured'));
        progressCircle.style.strokeDashoffset = '565';
        statusMsg.textContent = 'Positionnez votre visage dans le cercle';
        if (captureBtn) captureBtn.disabled = false;
    }

    function setProgress(captured, total) {
        const pct = captured / total;
        const offset = 565 * (1 - pct);
        progressCircle.style.strokeDashoffset = String(offset);
        for (let i = 0; i < total; i++) {
            const dot = document.getElementById('dot-' + i);
            if (dot) dot.classList.toggle('captured', i < captured);
        }
    }

    // â”€ Start camera â”€
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user', width: 640, height: 640 } });
            video.srcObject = stream;
        } catch (err) {
            statusMsg.textContent = 'âŒ Impossible d\'accÃ©der Ã  la camÃ©ra. VÃ©rifiez les permissions.';
            captureBtn.disabled = true;
        }
    }

    // â”€ Capture one frame, return Blob â”€
    function captureFrame() {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 640;
        canvas.getContext('2d').drawImage(video, 0, 0);
        return new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92));
    }

    // â”€ Setup flow â”€
    async function captureForSetup() {
        captureBtn.disabled = true;
        statusMsg.textContent = 'Analyse... restez immobile';

        const blob = await captureFrame();
        const form = new FormData();
        form.append('image', blob, 'face.jpg');

        try {
            const res  = await fetch(GENERATE_URL, { method: 'POST', body: form });
            const data = await res.json();

            if (data.error) {
                statusMsg.textContent = 'âš ï¸ ' + data.error;
                captureBtn.disabled = false;
                return;
            }

            capturedEncodings.push(data.encoding);
            setProgress(capturedEncodings.length, TOTAL_SETUP_FRAMES);

            if (capturedEncodings.length < TOTAL_SETUP_FRAMES) {
                const remaining = TOTAL_SETUP_FRAMES - capturedEncodings.length;
                statusMsg.textContent = `âœ… Photo ${capturedEncodings.length}/${TOTAL_SETUP_FRAMES} capturÃ©e. ${remaining} restante(s). Bougez lÃ©gÃ¨rement la tÃªte.`;
                captureBtn.disabled = false;
            } else {
                statusMsg.textContent = 'Finalisation de la configuration...';
                await registerFace();
            }
        } catch (e) {
            statusMsg.textContent = 'âŒ Erreur rÃ©seau. RÃ©essayez.';
            captureBtn.disabled = false;
        }
    }

    async function registerFace() {
        try {
            const res  = await fetch(REGISTER_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    encodings: capturedEncodings,
                    email: currentEmail 
                }),
            });
            const data = await res.json();
            stopCamera();

            if (data.success) {
                successTitle.textContent = 'Face ID configurÃ© !';
                successMsg.textContent = 'Votre Face ID est prÃªt. Reconnectez-vous pour l\'utiliser.';
                showStep(successStep);
            } else {
                errorMsg.textContent = data.error || 'Erreur lors de la configuration.';
                showStep(errorStep);
            }
        } catch (e) {
            errorMsg.textContent = 'Erreur rÃ©seau lors de la sauvegarde.';
            showStep(errorStep);
        }
    }

    // â”€ Login flow â”€
    async function captureForLogin() {
        captureBtn.disabled = true;
        statusMsg.textContent = 'Analyse du visage...';
        progressCircle.style.strokeDashoffset = '280'; // 50% progress

        const blob = await captureFrame();
        const form = new FormData();
        form.append('email', currentEmail);
        form.append('image', blob, 'face.jpg');

        try {
            const res  = await fetch(LOGIN_URL, { method: 'POST', body: form });
            const data = await res.json();

            if (data.success) {
                progressCircle.style.strokeDashoffset = '0';
                stopCamera();
                successTitle.textContent = 'ConnectÃ© !';
                successMsg.textContent = 'Bienvenue ! Redirection en cours...';
                showStep(successStep);
                setTimeout(() => window.location.href = data.redirect, 1200);
            } else {
                stopCamera();
                errorMsg.textContent = data.error || 'Visage non reconnu.';
                showStep(errorStep);
            }
        } catch (e) {
            stopCamera();
            errorMsg.textContent = 'Erreur rÃ©seau. RÃ©essayez.';
            showStep(errorStep);
        }
    }

    // â”€ Event listeners â”€
    btnFaceId.addEventListener('click', openModal);

    document.getElementById('faceid-close').addEventListener('click', closeModal);
    document.getElementById('faceid-close-2').addEventListener('click', closeModal);
    document.getElementById('faceid-modal-close-bg').addEventListener('click', closeModal);

    confirmBtn.addEventListener('click', async () => {
        currentEmail = emailInput.value.trim();
        if (!currentEmail || !currentEmail.includes('@')) {
            emailInput.style.borderColor = 'red';
            return;
        }
        emailInput.style.borderColor = '';
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'VÃ©rification...';

        // Check if Face ID is configured for this email
        const res  = await fetch(STATUS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail }),
        });
        const data = await res.json();
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Continuer';

        isSetupMode = !data.configured;

        if (isSetupMode) {
            modeTitle.textContent    = 'Configuration Face ID';
            modeSubtitle.textContent = 'Prenez 5 photos pour entraÃ®ner votre Face ID (comme sur iPhone)';
            setupDots.style.display  = 'flex';
            captureBtn.textContent   = 'ğŸ“¸ Capturer';
        } else {
            modeTitle.textContent    = 'Connexion Face ID';
            modeSubtitle.textContent = 'Regardez la camÃ©ra pour vous connecter';
            setupDots.style.display  = 'none';
            captureBtn.textContent   = 'ğŸ” Me connecter';
        }

        showStep(cameraStep);
        await startCamera();
    });

    captureBtn.addEventListener('click', () => {
        if (isSetupMode) captureForSetup();
        else captureForLogin();
    });

    retryBtn.addEventListener('click', async () => {
        capturedEncodings = [];
        document.querySelectorAll('.faceid-dot').forEach(d => d.classList.remove('captured'));
        progressCircle.style.strokeDashoffset = '565';
        captureBtn.disabled = false;
        statusMsg.textContent = 'Positionnez votre visage dans le cercle';
        showStep(cameraStep);
        await startCamera();
    });

    // Close on ESC
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape' && modal.style.display !== 'none') closeModal();
    });
})();
</script>

{% if auto_login is defined and auto_login %}
<script>
    // Auto-connexion pour le flux de certification
    document.addEventListener('DOMContentLoaded', function() {
        // Message informatif
        const message = document.createElement('div');
        message.className = 'modern-info-alert';
        message.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center;';
        message.innerHTML = 'ğŸš€ Connexion automatique en cours pour votre certification...';
        
        const form = document.querySelector('.modern-auth-form');
        form.parentNode.insertBefore(message, form);
        
        // Soumettre le formulaire aprÃ¨s 2 secondes
        setTimeout(function() {
            message.innerHTML = 'ğŸ”„ Connexion en cours...';
            form.submit();
        }, 2000);
    });
</script>
{% endif %}

<script>
// Toggle mot de passe
document.getElementById('toggle-password').addEventListener('click', function() {
    const passwordInput = document.getElementById('_password');
    const eyeIcon = document.getElementById('eye-icon');
    const eyeOffIcon = document.getElementById('eye-off-icon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.style.display = 'none';
        eyeOffIcon.style.display = 'block';
    } else {
        passwordInput.type = 'password';
        eyeIcon.style.display = 'block';
        eyeOffIcon.style.display = 'none';
    }
});
</script>

<style>
.password-toggle {
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #666;
    transition: color 0.3s ease;
}

.password-toggle:hover {
    color: #333;
}

.modern-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.modern-input {
    flex: 1;
    padding-right: 50px !important;
}
</style>

<style>
.modern-premium-alert {
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-weight: 500;
    font-size: 14px;
}


/* Forcer l'affichage du badge reCAPTCHA v3 */
.grecaptcha-badge {
    visibility: visible !important;
    opacity: 1 !important;
}

/* Position personnalisÃ©e du badge */
.grecaptcha-badge {
    bottom: 20px !important;
    right: 20px !important;
    z-index: 1000 !important;
}
</style>

{% endblock %}

{% block javascripts %}
{{ parent() }}
<!-- reCAPTCHA v3 -->
<script src="https://www.google.com/recaptcha/api.js?render={{ recaptcha_site_key }}"></script>
<script>
// reCAPTCHA v3 - Logs dÃ©taillÃ©s pour le debug
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ”’ reCAPTCHA Debug Mode ActivÃ©');
    console.log('ğŸ“ Site Key:', '{{ recaptcha_site_key }}');
    console.log('ğŸŒ Hostname:', window.location.hostname);
    console.log('ğŸ”— Full URL:', window.location.href);
    
    // Attendre que reCAPTCHA soit prÃªt
    if (typeof grecaptcha !== 'undefined') {
        console.log('â³ reCAPTCHA script chargÃ©, attente de ready...');
        
        grecaptcha.ready(function() {
            console.log('âœ… reCAPTCHA is ready!');
            
            // ExÃ©cuter reCAPTCHA au chargement
            grecaptcha.execute('{{ recaptcha_site_key }}', {action: 'page_load'}).then(function(token) {
                console.log('ğŸ¯ Token gÃ©nÃ©rÃ© (page_load):', token.substring(0, 30) + '...');
                console.log('ğŸ“Š Longueur du token:', token.length);
                
                // Mettre le token dans le champ cachÃ©
                const recaptchaResponse = document.getElementById('recaptcha-response');
                if (recaptchaResponse) {
                    recaptchaResponse.value = token;
                    console.log('ğŸ’¾ Token stockÃ© dans le champ cachÃ©');
                }
            }).catch(function(error) {
                console.error('âŒ Erreur gÃ©nÃ©ration token (page_load):', error);
            });
        });
    } else {
        console.log('âŒ reCAPTCHA script non trouvÃ©');
    }
    
    // Intercepter la soumission du formulaire
    const form = document.querySelector('.modern-auth-form');
    if (form) {
        console.log('ğŸ“ Formulaire trouvÃ©, ajout de l\'Ã©couteur d\'Ã©vÃ©nement');
        
        form.addEventListener('submit', function(e) {
            console.log('ğŸš€ Soumission du formulaire dÃ©tectÃ©e');
            e.preventDefault();
            
            if (typeof grecaptcha !== 'undefined') {
                console.log('ğŸ”„ GÃ©nÃ©ration d\'un nouveau token pour la soumission...');
                
                grecaptcha.ready(function() {
                    grecaptcha.execute('{{ recaptcha_site_key }}', {action: 'form_submit'}).then(function(token) {
                        console.log('âœ… Token gÃ©nÃ©rÃ© (form_submit):', token.substring(0, 30) + '...');
                        console.log('ğŸ“Š Longueur du token:', token.length);
                        
                        // Mettre le token dans le champ cachÃ©
                        const recaptchaResponse = document.getElementById('recaptcha-response');
                        if (recaptchaResponse) {
                            recaptchaResponse.value = token;
                            console.log('ğŸ’¾ Token mis Ã  jour pour la soumission');
                            console.log('ğŸ” Valeur du champ cachÃ©:', recaptchaResponse.value.substring(0, 30) + '...');
                        }
                        
                        console.log('ğŸ“¤ Envoi du formulaire...');
                        form.submit();
                    }).catch(function(error) {
                        console.error('âŒ Erreur gÃ©nÃ©ration token (form_submit):', error);
                        console.log('âš ï¸ Envoi du formulaire sans reCAPTCHA (fallback)');
                        form.submit();
                    });
                });
            } else {
                console.log('âš ï¸ reCAPTCHA non disponible, envoi direct');
                form.submit();
            }
        });
    } else {
        console.log('âŒ Formulaire non trouvÃ©');
    }
    
    // Fonction de test manuel
    window.testRecaptchaDebug = function() {
        console.log('ğŸ§ª === Test reCAPTCHA Debug ===');
        console.log('ğŸ“ Site Key:', '{{ recaptcha_site_key }}');
        console.log('ğŸŒ Hostname:', window.location.hostname);
        console.log('ğŸ”— grecaptcha object:', typeof grecaptcha);
        console.log('ğŸ”§ grecaptcha.execute:', typeof grecaptcha?.execute);
        
        if (typeof grecaptcha !== 'undefined') {
            grecaptcha.ready(function() {
                console.log('âœ… reCAPTCHA ready pour test');
                
                grecaptcha.execute('{{ recaptcha_site_key }}', {action: 'manual_test'}).then(function(token) {
                    console.log('ğŸ¯ Token gÃ©nÃ©rÃ© (manuel):', token);
                    console.log('ğŸ“Š Longueur:', token.length);
                    console.log('ğŸ” Premier caractÃ¨res:', token.substring(0, 10) + '...');
                    console.log('ğŸ” Dernier caractÃ¨res:', '...' + token.substring(token.length - 10));
                }).catch(function(error) {
                    console.error('âŒ Erreur test manuel:', error);
                });
            });
        } else {
            console.log('âŒ reCAPTCHA non disponible pour test');
        }
    };
    
    console.log('ğŸ’¡ Tapez testRecaptchaDebug() dans la console pour tester manuellement');
});
</script>
{% endblock %}
