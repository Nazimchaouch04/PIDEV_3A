<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BioSync{% endblock %}</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2245%22 fill=%22%236EC5A6%22/><text x=%2250%22 y=%2265%22 font-size=%2240%22 text-anchor=%22middle%22 fill=%22white%22>B</text></svg>">
    <link rel="stylesheet" href="{{ asset('css/fonts.css') }}">
    <link rel="stylesheet" href="{{ asset('css/style.css') }}">
    {% block stylesheets %}{% endblock %}
</head>
<body>
    <div class="flash-messages-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
        {% for label, messages in app.flashes %}
            {% for message in messages %}
                <div class="alert alert-{{ label == 'error' ? 'danger' : label }}"
                     style="padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid;
                            background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            {% if label == 'success' %} border-color: #28a745; color: #155724;
                            {% elseif label == 'danger' or label == 'error' %} border-color: #dc3545; color: #721c24;
                            {% else %} border-color: #17a2b8; color: #0c5460; {% endif %}">
                    {{ message }}
                    <button type="button" onclick="this.parentElement.style.display='none'"
                            style="float: right; border: none; background: transparent; cursor: pointer; font-weight: bold;">&times;</button>
                </div>
            {% endfor %}
        {% endfor %}
    </div>

    {% block body %}{% endblock %}

    <script src="{{ asset('js/app.js') }}"></script>

    <script>
        (function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(function(alert) {
                alert.style.transition = "opacity 0.5s ease";
                alert.style.opacity = "0";
                setTimeout(function() { alert.remove(); }, 500);
            });
        })();
    </script>

    {# âœ… CHATBOT #}
    <div id="chatbot-btn" onclick="toggleChat()" title="Chatbot BioSync">ðŸ’¬</div>

    <div id="chatbot-box" style="display:none;">
        <div id="chatbot-header">
            ðŸ¤– Assistant BioSync
            <span onclick="toggleChat()" style="cursor:pointer;float:right;">âœ•</span>
        </div>
        <div id="chatbot-messages">
            <div class="bot-msg">ðŸ‘‹ Bonjour ! Posez-moi vos questions sur les sÃ©ances et exercices.</div>
        </div>
        <div id="chatbot-input-area">
            <input type="text" id="chatbot-input" placeholder="Ex: combien de sÃ©ances ?"
                   onkeypress="if(event.key==='Enter') envoyerMessage()"/>
            <button onclick="envoyerMessage()">Envoyer</button>
        </div>
    </div>

    <style>
    #chatbot-btn {
        position: fixed; bottom: 30px; right: 30px;
        background: #4f46e5; color: white; font-size: 28px;
        width: 60px; height: 60px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 4px 15px rgba(79,70,229,0.4);
        z-index: 1000;
    }
    #chatbot-box {
        position: fixed; bottom: 100px; right: 30px;
        width: 340px; background: white; border-radius: 16px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15); z-index: 1000;
        font-family: sans-serif; overflow: hidden;
    }
    #chatbot-header { background: #4f46e5; color: white; padding: 14px 16px; font-weight: bold; }
    #chatbot-messages { height: 280px; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .bot-msg { background: #f1f5f9; padding: 10px 14px; border-radius: 12px 12px 12px 0; max-width: 85%; font-size: 14px; }
    .user-msg { background: #4f46e5; color: white; padding: 10px 14px; border-radius: 12px 12px 0 12px; max-width: 85%; align-self: flex-end; font-size: 14px; }
    #chatbot-input-area { display: flex; padding: 10px; border-top: 1px solid #e2e8f0; gap: 8px; }
    #chatbot-input { flex: 1; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 13px; outline: none; }
    #chatbot-input-area button { background: #4f46e5; color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; }
    </style>

    <script>
    function toggleChat() {
        const box = document.getElementById('chatbot-box');
        box.style.display = box.style.display === 'none' ? 'block' : 'none';
    }
    async function envoyerMessage() {
        const input = document.getElementById('chatbot-input');
        const messages = document.getElementById('chatbot-messages');
        const texte = input.value.trim();
        if (!texte) return;
        messages.innerHTML += `<div class="user-msg">${texte}</div>`;
        input.value = '';
        messages.scrollTop = messages.scrollHeight;
        const res = await fetch('/chatbot/message', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: texte})
        });
        const data = await res.json();
        messages.innerHTML += `<div class="bot-msg">${data.reponse}</div>`;
        messages.scrollTop = messages.scrollHeight;
    }
    </script>
    {# âœ… FIN CHATBOT #}

    {% block javascripts %}{% endblock %}
</body>
</html>